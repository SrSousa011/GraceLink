pipeline {
    agent any

    stages {
        // Increase Git buffer size and timeout before checkout
        stage('Prepare Git Configurations') {
            steps {
                script {
                    // Increase the Git buffer size to handle large fetches (500MB)
                    bat 'git config --global http.postBuffer 524288000'  // 500MB buffer
                    // Set a larger timeout for Git fetch (10 minutes)
                    bat 'git config --global fetch.timeout 600'  // 600 seconds (10 minutes)
                }
            }
        }

        // Checkout the repository
        stage('Checkout') {
            steps {
                script {
                    // Corrected checkout with shallow clone
                    checkout([
                        $class: 'GitSCM', 
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[url: 'https://github.com/SrSousa011/GraceLink.git']],
                        extensions: [[$class: 'CloneOption', shallow: true, depth: 1]]
                    ])
                }
            }
        }

        // Clean up workspace
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        // Flutter clean step
        stage('Flutter Clean') {
            steps {
                bat 'flutter clean'
            }
        }

        // Install Flutter dependencies
        stage('Install Dependencies') {
            steps {
                bat 'flutter pub get'
            }
        }

        // Run Flutter tests
        stage('Run Tests') {
            steps {
                bat 'flutter test'
            }
        }

        // Build the app bundle for release
        stage('Build App Bundle') {
            steps {
                bat 'flutter build appbundle --release'
            }
        }

        // Success stage
        stage('Success') {
            steps {
                script {
                    echo "Pipeline executed successfully!"
                }
            }
        }
    }

    // Post actions for success and failure
    post {
        success {
            script {
                echo "Build and tests succeeded!"
            }
        }
        failure {
            script {
                echo "Build or tests failed. Check the logs for details."
            }
        }
    }
}
